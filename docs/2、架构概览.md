# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## 1. æ¶æ„æ¦‚è§ˆ (Architecture Overview)

### æ¶æ„è®¾è®¡ç†å¿µ
Litho Book æ˜¯ä¸€ä¸ªé¢å‘æœ¬åœ°çŸ¥è¯†ç®¡ç†çš„å…¨æ ˆåº”ç”¨ï¼Œå…¶æ ¸å¿ƒè®¾è®¡éµå¾ª**èŒè´£åˆ†ç¦»åŸåˆ™**ï¼ˆSeparation of Concernsï¼‰å’Œ**é«˜å†…èšä½è€¦åˆ**çš„è®¾è®¡å“²å­¦ã€‚ç³»ç»Ÿé€šè¿‡æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œå°†ç”¨æˆ·äº¤äº’ã€æ•°æ®å¤„ç†ä¸ç³»ç»Ÿæ”¯æ’‘èƒ½åŠ›è§£è€¦ï¼Œç¡®ä¿å„ç»„ä»¶ä¸“æ³¨äºå•ä¸€èŒè´£ã€‚

è¯¥ç³»ç»Ÿé‡‡ç”¨ **"å‘½ä»¤è¡Œå¯åŠ¨ + Web æœåŠ¡"** çš„æ··åˆæ¶æ„æ¨¡å¼ï¼Œæ—¢ä¿ç•™äº†å¼€å‘è€…ç†Ÿæ‚‰çš„ CLI é…ç½®æ–¹å¼ï¼Œåˆæä¾›äº†ç°ä»£åŒ–çš„ Web æµè§ˆä½“éªŒã€‚æ•´ä½“æ¶æ„å¼ºè°ƒï¼š
- **ç±»å‹å®‰å…¨**ï¼šåŸºäº Rust çš„å¼ºç±»å‹ç³»ç»Ÿï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- **é›¶æˆæœ¬æŠ½è±¡**ï¼šåˆ©ç”¨ Rust çš„å¼‚æ­¥è¿è¡Œæ—¶ Tokio å®ç°é«˜æ€§èƒ½ I/O æ“ä½œ
- **å†…å­˜å®‰å…¨**ï¼šæ— éœ€åƒåœ¾å›æ”¶å™¨å³å¯é˜²æ­¢ç©ºæŒ‡é’ˆã€ç¼“å†²åŒºæº¢å‡ºç­‰å¸¸è§æ¼æ´
- **å¯ç»´æŠ¤æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ä¾¿äºæœªæ¥åŠŸèƒ½æ‰©å±•ä¸é‡æ„

### æ ¸å¿ƒæ¶æ„æ¨¡å¼
ç³»ç»Ÿé‡‡ç”¨å…¸å‹çš„**åˆ†å±‚æ¶æ„**ï¼ˆLayered Architectureï¼‰ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š
1. **ç”¨æˆ·äº¤äº’åŸŸ**ï¼šå¤„ç† CLI å‚æ•°è§£æä¸ HTTP è¯·æ±‚å“åº”
2. **æ–‡æ¡£æ•°æ®åŸŸ**ï¼šè´Ÿè´£æ–‡ä»¶æ‰«æã€å†…å®¹ç´¢å¼•ä¸æœç´¢é€»è¾‘
3. **ç³»ç»Ÿæ”¯æ’‘åŸŸ**ï¼šæä¾›æ—¥å¿—ã€é”™è¯¯å¤„ç†ç­‰åŸºç¡€è®¾æ–½èƒ½åŠ›

åŒæ—¶ï¼Œåœ¨ Web å±‚é‡‡ç”¨äº† **Axum æ¡†æ¶çš„å‡½æ•°å¼è·¯ç”±+çŠ¶æ€æ³¨å…¥**æ¨¡å¼ï¼Œé€šè¿‡ `AppState` å°†å…±äº«èµ„æºï¼ˆå¦‚ `DocumentTree`ï¼‰å®‰å…¨åœ°ä¼ é€’ç»™æ‰€æœ‰è¯·æ±‚å¤„ç†å™¨ã€‚

### æŠ€æœ¯æ ˆæ¦‚è¿°
| ç±»åˆ« | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| **Web æ¡†æ¶** | Axum | åŸºäº Tokio çš„é«˜æ€§èƒ½ Rust Web æ¡†æ¶ï¼Œæ”¯æŒå¼‚æ­¥å¤„ç† |
| **å¼‚æ­¥è¿è¡Œæ—¶** | Tokio | æä¾›å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ä¸ I/O å¤šè·¯å¤ç”¨ |
| **CLI è§£æ** | Clap | å¼ºå¤§çš„å‘½ä»¤è¡Œå‚æ•°è§£æåº“ï¼Œæ”¯æŒè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ |
| **é”™è¯¯å¤„ç†** | Anyhow + ThisError | ç»Ÿä¸€çš„åº”ç”¨çº§é”™è¯¯å¤„ç†æ–¹æ¡ˆ |
| **æ—¥å¿—ç³»ç»Ÿ** | Tracing + Subscriber | ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Œæ”¯æŒä¸åŒçº§åˆ«è¾“å‡º |
| **JSON åºåˆ—åŒ–** | Serde | é«˜æ€§èƒ½çš„æ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–æ¡†æ¶ |
| **HTTP å®¢æˆ·ç«¯** | Reqwest | æ”¯æŒæµå¼å“åº”çš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ |
| **Markdown æ¸²æŸ“** | Pulldown-Cmark | å®‰å…¨é«˜æ•ˆçš„ Markdown åˆ° HTML è½¬æ¢å™¨ |
| **æ—¶é—´å¤„ç†** | Chrono | æ—¥æœŸæ—¶é—´æ“ä½œåº“ï¼Œæ”¯æŒåºåˆ—åŒ– |

```mermaid
graph TD
    subgraph "å¤–éƒ¨ç³»ç»Ÿ"
        ZhipuAI[æ™ºè°±AI OpenAIå…¼å®¹API]
    end

    subgraph "ç”¨æˆ·äº¤äº’åŸŸ"
        CLI[å‘½ä»¤è¡Œå‚æ•°è§£æ]
        Server[Axum WebæœåŠ¡]
    end

    subgraph "æ–‡æ¡£æ•°æ®åŸŸ"
        FS[æ–‡æ¡£æ ‘æ„å»º å…¨æ–‡æœç´¢ Markdownæ¸²æŸ“]
    end

    subgraph "ç³»ç»Ÿæ”¯æ’‘åŸŸ"
        Main[ä¸»ç¨‹åºåè°ƒ]
        Error[ç»Ÿä¸€é”™è¯¯å¤„ç†]
    end

    Main -->|"è°ƒç”¨"| CLI
    Main -->|"è°ƒç”¨"| FS
    Main -->|"åˆ›å»º"| Server
    Main -->|"æ³¨å…¥çŠ¶æ€"| Server

    CLI -->|"æä¾›é…ç½®"| Main
    FS -->|"è¿”å›DocumentTree"| Main
    FS -->|"å¯èƒ½æŠ›å‡ºIO JSONé”™è¯¯"| Error

    Server -->|"ä¾èµ–"| FS
    Server -->|"ä½¿ç”¨"| Error
    Server -->|"å‘èµ·è¯·æ±‚"| ZhipuAI

    CLI -->|"è¢«è°ƒç”¨"| Main
    Error -->|"å®ç°From<T> for StatusCode"| Server

    style CLI fill:#e1f5fe,stroke:#039be5
    style Server fill:#e1f5fe,stroke:#039be5
    style FS fill:#f0f4c3,stroke:#afb42b
    style Main fill:#ffecb3,stroke:#ffb300
    style Error fill:#ffecb3,stroke:#ffb300
    style ZhipuAI fill:#f3e5f5,stroke:#8e24aa
```

---

## 2. ç³»ç»Ÿä¸Šä¸‹æ–‡ (System Context)

### ç³»ç»Ÿå®šä½ä¸ä»·å€¼
Litho Book æ˜¯ä¸€ä¸ªæœ¬åœ°çŸ¥è¯†å¢å¼ºç³»ç»Ÿï¼Œæ—¨åœ¨è§£å†³ä¸ªäººçŸ¥è¯†ç¢ç‰‡åŒ–é—®é¢˜ã€‚å®ƒå°†åˆ†æ•£åœ¨æœ¬åœ°çš„ Markdown æ–‡æ¡£è½¬åŒ–ä¸ºç»“æ„åŒ–ã€å¯æœç´¢çš„çŸ¥è¯†åº“ï¼Œå¹¶é›†æˆ AI åŠ©æ‰‹åŠŸèƒ½ï¼Œæ˜¾è‘—æå‡çŸ¥è¯†å·¥ä½œè€…çš„ä¿¡æ¯æ£€ç´¢æ•ˆç‡ä¸åˆ›ä½œä½“éªŒã€‚

**æ ¸å¿ƒä¸šåŠ¡ä»·å€¼**ï¼š
- âœ… **ç¦»çº¿å¯ç”¨**ï¼šæ‰€æœ‰æ–‡æ¡£ä¿ç•™åœ¨æœ¬åœ°ï¼Œæ— éœ€ä¸Šä¼ äº‘ç«¯
- âœ… **å¿«é€Ÿè®¿é—®**ï¼šä¸€é”®å¯åŠ¨ Web æœåŠ¡ï¼Œå³æ—¶æµè§ˆæ–‡æ¡£ç›®å½•
- âœ… **æ™ºèƒ½æœç´¢**ï¼šæ”¯æŒå…¨æ–‡å…³é”®è¯åŒ¹é…ä¸ç›¸å…³æ€§æ’åº
- âœ… **AI è¾…åŠ©**ï¼šé€šè¿‡è‡ªç„¶è¯­è¨€é—®ç­”è·å–æ–‡æ¡£ç›¸å…³å†…å®¹è§£é‡Š
- âœ… **è½»é‡é«˜æ•ˆ**ï¼šå•äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²ï¼Œæ— å¤æ‚ä¾èµ–

### ç”¨æˆ·è§’è‰²ä¸åœºæ™¯
| è§’è‰² | å…¸å‹ä½¿ç”¨åœºæ™¯ |
|------|-------------|
| **å¼€å‘è€…** | - å¿«é€ŸæŸ¥é˜…æŠ€æœ¯æ–‡æ¡£/API æ³¨é‡Š<br>- åœ¨æµè§ˆå™¨ä¸­ç»“æ„åŒ–å±•ç¤ºä»£ç ç¬”è®°<br>- ä½¿ç”¨ AI åŠ©æ‰‹ç†è§£å¤æ‚æ¶æ„è®¾è®¡ |
| **çŸ¥è¯†å·¥ä½œè€…** | - æ•´ç†è¯»ä¹¦ç¬”è®°ä¸ç ”ç©¶èµ„æ–™<br>- åŸºäºå…³é”®è¯å¿«é€Ÿå®šä½å†å²è®°å½•<br>- é€šè¿‡å¯¹è¯å½¢å¼å›é¡¾çŸ¥è¯†ç‚¹ |

### å¤–éƒ¨ç³»ç»Ÿäº¤äº’
| å¤–éƒ¨ç³»ç»Ÿ | äº¤äº’æ–¹å¼ | ç”¨é€” |
|--------|---------|------|
| **æ™ºè°±AI OpenAIå…¼å®¹API** | HTTP/REST + SSE | è·å–æµå¼ AI å›ç­”ï¼Œç”¨äºæ–‡æ¡£é—®ç­”åŠŸèƒ½ |

> âš ï¸ **å®‰å…¨æé†’**ï¼šå½“å‰ API å¯†é’¥ç¡¬ç¼–ç åœ¨æºç ä¸­ï¼ˆ`b0c0afc3b5d0402db47e5132fc0fa882.6vyDm2pOv2NSy5z7`ï¼‰ï¼Œå­˜åœ¨æ³„éœ²é£é™©ï¼Œå»ºè®®æ”¹ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥ã€‚

### ç³»ç»Ÿè¾¹ç•Œå®šä¹‰
#### åŒ…å«ç»„ä»¶
- å‘½ä»¤è¡Œå‚æ•°è§£æ (`cli.rs`)
- æ–‡ä»¶ç³»ç»Ÿæ‰«æä¸æ–‡æ¡£æ ‘æ„å»º (`filesystem.rs`)
- ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶ (`error.rs`)
- Axum HTTP æœåŠ¡ç«¯ (`server.rs`)
- ä¸»ç¨‹åºå…¥å£åè°ƒ (`main.rs`)

#### æ’é™¤ç»„ä»¶
- å‰ç«¯ React/Vue ç•Œé¢ï¼ˆHTML æ¨¡æ¿ä¸ºé™æ€åµŒå…¥ï¼‰
- Markdown æ–‡ä»¶ç”Ÿæˆå·¥å…·
- æ–‡æ¡£ç‰ˆæœ¬æ§åˆ¶ï¼ˆå¦‚ Gitï¼‰
- ç”¨æˆ·è®¤è¯ä¸æƒé™ç³»ç»Ÿ
- äº‘å­˜å‚¨åŒæ­¥æœåŠ¡
- AI æ¨¡å‹è®­ç»ƒæˆ–å¾®è°ƒ

```mermaid
graph LR
    User((ç”¨æˆ·))

    subgraph "Litho Book ç³»ç»Ÿ"
        CLI[å‘½ä»¤è¡Œæ¥å£]
        Web[Web æœåŠ¡]
        DocEngine[æ–‡æ¡£å¼•æ“]
        AI[AI åŠ©æ‰‹]
    end

    External[ZhipuAI API]

    User -- "å¯åŠ¨åº”ç”¨" --> CLI
    User -- "æµè§ˆ/æœç´¢/æé—®" --> Web
    Web -- "è·å–å›ç­”" --> AI
    AI -- "è°ƒç”¨API" --> External
    DocEngine -- "æä¾›å†…å®¹" --> Web

    style User fill:#f9f,stroke:#333
    style External fill:#f3e5f5,stroke:#8e24aa
    classDef system fill:#bbdefb,stroke:#1976d2;
    class CLI,Web,DocEngine,AI system
```

---

## 3. å®¹å™¨è§†å›¾ (Container View)

### é¢†åŸŸæ¨¡å—åˆ’åˆ†
Litho Book çš„å®¹å™¨å±‚çº§ç”±å››ä¸ªä¸»è¦ç»„ä»¶æ„æˆï¼š

| å®¹å™¨ | æŠ€æœ¯å®ç° | èŒè´£ |
|------|----------|------|
| **CLI æ¥å£** | `cli.rs` + Clap | è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ŒéªŒè¯è¾“å…¥åˆæ³•æ€§ |
| **Web æœåŠ¡** | `server.rs` + Axum | æä¾› RESTful API ä¸ SSE æµå¼å“åº” |
| **æ–‡æ¡£å¼•æ“** | `filesystem.rs` | æ‰«æç›®å½•ã€æ„å»ºæ ‘å½¢ç»“æ„ã€æ‰§è¡Œæœç´¢ |
| **ä¸»ç¨‹åº** | `main.rs` | åè°ƒå„æ¨¡å—ï¼Œæ§åˆ¶åº”ç”¨ç”Ÿå‘½å‘¨æœŸ |

### é¢†åŸŸæ¨¡å—æ¶æ„
#### ç”¨æˆ·äº¤äº’åŸŸ
- **å‘½ä»¤è¡Œæ¥å£**
  - è§£æ `--path`, `--port`, `--host`, `--open`, `--verbose`
  - éªŒè¯æ–‡æ¡£è·¯å¾„å­˜åœ¨æ€§åŠæƒé™ï¼ˆä½ç«¯å£éœ€ç®¡ç†å‘˜æƒé™ï¼‰
  - æä¾›è·¨å¹³å°æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€æ”¯æŒ
- **Web æœåŠ¡æ¥å£**
  - å®ç°ä»¥ä¸‹å…³é”®è·¯ç”±ï¼š
    - `GET /` â†’ è¿”å›é¦–é¡µ HTML
    - `GET /api/tree` â†’ è·å–æ–‡æ¡£æ ‘ç»“æ„
    - `GET /api/file?file=xxx.md` â†’ è·å–æ–‡ä»¶å†…å®¹ä¸ HTML æ¸²æŸ“ç»“æœ
    - `GET /api/search?q=å…³é”®è¯` â†’ æ‰§è¡Œå…¨æ–‡æœç´¢
    - `GET /api/stats` â†’ è·å–æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯
    - `POST /api/chat` â†’ æµå¼ AI å¯¹è¯ï¼ˆSSEï¼‰

#### æ–‡æ¡£æ•°æ®åŸŸ
- **æ–‡æ¡£æ ‘æ„å»ºå™¨**
  - é€’å½’æ‰«ææŒ‡å®šç›®å½•ï¼Œæ„å»ºå†…å­˜ä¸­çš„ `DocumentTree`
  - å¿½ç•¥éšè—æ–‡ä»¶ï¼ˆ`.` å¼€å¤´ï¼‰å’Œé `.md` æ–‡ä»¶
  - ç»´æŠ¤ `FileNode` æ ‘å½¢ç»“æ„ï¼ŒåŒ…å«è·¯å¾„ã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰å…ƒæ•°æ®
  - å»ºç«‹ `file_map` æ˜ å°„ï¼ˆç›¸å¯¹è·¯å¾„ â†’ å®é™…è·¯å¾„ï¼‰ç”¨äºå¿«é€ŸæŸ¥æ‰¾
- **å…¨æ–‡æœç´¢å¼•æ“**
  - åœ¨ `search_index` ä¸­ç¼“å­˜æ¯ä¸ªæ–‡ä»¶çš„æ‰€æœ‰è¡Œæ–‡æœ¬
  - æ”¯æŒå…³é”®è¯åŒ¹é…ï¼Œç»“åˆå¤šç§å› ç´ è®¡ç®—ç›¸å…³æ€§è¯„åˆ†ï¼š
    - æ ‡é¢˜æƒé‡ï¼ˆH1/H2 åŠ æƒ Ã—3ï¼‰
    - ç²¾ç¡®è¯åŒ¹é…ï¼ˆÃ—2ï¼‰
    - è¡Œé¦–åŒ¹é…ï¼ˆÃ—1.5ï¼‰
    - æ–‡ä»¶ååŒ¹é…ï¼ˆ+2 åˆ†ï¼‰
  - è¿”å›å¸¦ `<mark>` é«˜äº®æ ‡ç­¾çš„ç»“æœç‰‡æ®µä¸ä¸Šä¸‹æ–‡
- **Markdown æ¸²æŸ“å™¨**
  - ä½¿ç”¨ `pulldown-cmark` å°† Markdown è½¬æ¢ä¸º HTML
  - æ”¯æŒè¡¨æ ¼ã€è„šæ³¨ã€åˆ é™¤çº¿ã€ä»»åŠ¡åˆ—è¡¨ç­‰æ‰©å±•è¯­æ³•

#### ç³»ç»Ÿæ”¯æ’‘åŸŸ
- **é”™è¯¯å¤„ç†ä¸­æ¢ (`error.rs`)**
  - å®šä¹‰ç»Ÿä¸€çš„ `LithoBookError` æšä¸¾ç±»å‹
  - è‡ªåŠ¨æ˜ å°„è‡³ HTTP çŠ¶æ€ç ï¼ˆå¦‚ `FileNotFound â†’ 404`ï¼‰
  - æ”¯æŒä» `std::io::Error`, `serde_json::Error` ç­‰æ ‡å‡†é”™è¯¯è‡ªåŠ¨è½¬æ¢
- **ç¨‹åºå¯åŠ¨åè°ƒ (`main.rs`)**
  - ä¸»å…¥å£å‡½æ•°ï¼Œè´Ÿè´£æ•´ä¸ªç”Ÿå‘½å‘¨æœŸè°ƒåº¦
  - æ‰§è¡Œæµç¨‹ï¼š
    1. è§£æ CLI å‚æ•°
    2. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆTracingï¼‰
    3. æ‰“å°å¯åŠ¨æ¨ªå¹…
    4. éªŒè¯å‚æ•°åˆæ³•æ€§
    5. æ„å»º `DocumentTree`
    6. åˆ›å»º Axum è·¯ç”±å™¨å¹¶ç»‘å®šçŠ¶æ€
    7. å¯åŠ¨ TCP ç›‘å¬
    8. å¯é€‰ï¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨

### å­˜å‚¨è®¾è®¡
æœ¬ç³»ç»Ÿé‡‡ç”¨**å†…å­˜é©»ç•™å‹å­˜å‚¨æ¶æ„**ï¼Œä¸ä¾èµ–å¤–éƒ¨æ•°æ®åº“ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | ç”Ÿå‘½å‘¨æœŸ |
|---------|--------|----------|
| æ–‡æ¡£æ ‘ç»“æ„ | å†…å­˜ (`DocumentTree`) | åº”ç”¨è¿è¡ŒæœŸé—´ |
| æ–‡ä»¶å†…å®¹ç´¢å¼• | å†…å­˜ (`HashMap<String, Vec<String>>`) | åº”ç”¨è¿è¡ŒæœŸé—´ |
| æ–‡ä»¶è·¯å¾„æ˜ å°„ | å†…å­˜ (`HashMap<String, PathBuf>`) | åº”ç”¨è¿è¡ŒæœŸé—´ |
| é™æ€æ¨¡æ¿ | ç¼–è¯‘æ—¶åµŒå…¥äºŒè¿›åˆ¶ | ç¼–è¯‘æœŸå›ºåŒ– |

> ğŸ’¡ **ä¼˜åŠ¿**ï¼šé¿å…ç£ç›˜ I/O å¼€é”€ï¼Œæå‡æœç´¢æ€§èƒ½
> ğŸ”§ **æ”¹è¿›å»ºè®®**ï¼šå¢åŠ çƒ­é‡è½½åŠŸèƒ½ï¼Œåœ¨æ–‡ä»¶å˜æ›´æ—¶é‡å»ºç´¢å¼•

### é¢†åŸŸæ¨¡å—é—´é€šä¿¡
| ä¾èµ–æ–¹å‘ | ç±»å‹ | æè¿° |
|--------|------|------|
| `main.rs` â†’ `cli.rs` | æœåŠ¡è°ƒç”¨ | ä¸»ç¨‹åºè°ƒç”¨ CLI æ¨¡å—è§£æå‘½ä»¤è¡Œå‚æ•° |
| `main.rs` â†’ `filesystem.rs` | æ•°æ®ä¾èµ– | æ„å»ºæ–‡æ¡£æ ‘å¹¶æ³¨å…¥ AppState |
| `main.rs` â†’ `server.rs` | æœåŠ¡è°ƒç”¨ | åˆ›å»ºè·¯ç”±å™¨å¹¶å¯åŠ¨æœåŠ¡ |
| `server.rs` â†’ `filesystem.rs` | æ•°æ®ä¾èµ– | è®¿é—® DocumentTree è¿›è¡Œæœç´¢ã€è¯»å–æ–‡ä»¶ |
| `server.rs` â†’ `error.rs` | æœåŠ¡è°ƒç”¨ | é”™è¯¯è‡ªåŠ¨è½¬æ¢ä¸º HTTP çŠ¶æ€ç  |
| `filesystem.rs` â†’ `error.rs` | æ•°æ®ä¾èµ– | IO/åºåˆ—åŒ–é”™è¯¯åŒ…è£…ä¸º LithoBookError |
| `server.rs` â†’ `reqwest` â†’ `ZhipuAI` | å¤–éƒ¨æœåŠ¡è°ƒç”¨ | æµå¼è°ƒç”¨ AI æ¥å£è·å–å›ç­” |

---

## 4. ç»„ä»¶è§†å›¾ (Component View)

### æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶
#### `DocumentTree` ç»„ä»¶
```rust
pub struct DocumentTree {
    pub root: FileNode,
    pub file_map: HashMap<String, PathBuf>,
    pub stats: TreeStats,
    pub search_index: HashMap<String, Vec<String>>,
}
```
- **èŒè´£**ï¼šå†…å­˜ä¸­è¡¨ç¤ºæ•´ä¸ªæ–‡æ¡£ç›®å½•çš„æ ‘å½¢ç»“æ„
- **å…³é”®æ–¹æ³•**ï¼š
  - `new(docs_dir)`ï¼šé€’å½’æ‰«æç›®å½•æ„å»ºæ ‘
  - `get_file_content()`ï¼šæ ¹æ®è·¯å¾„è¯»å–æ–‡ä»¶å†…å®¹
  - `render_markdown()`ï¼šå°† Markdown è½¬ä¸º HTML
  - `search_content(query)`ï¼šæ‰§è¡Œå…¨æ–‡æœç´¢å¹¶æ’åº

#### `AppState` ç»„ä»¶
```rust
pub struct AppState {
    pub doc_tree: DocumentTree,
    pub docs_path: String,
}
```
- **èŒè´£**ï¼šä½œä¸º Axum åº”ç”¨çš„å…±äº«çŠ¶æ€ï¼Œè´¯ç©¿æ‰€æœ‰è¯·æ±‚å¤„ç†å™¨
- **æ³¨å…¥æ–¹å¼**ï¼šé€šè¿‡ `.with_state(state)` æ³¨å…¥åˆ° Router

### æŠ€æœ¯æ”¯æ’‘ç»„ä»¶
#### `LithoBookError` ç»„ä»¶
```rust
#[derive(Error, Debug)]
pub enum LithoBookError {
    Io(#[from] std::io::Error),
    Json(#[from] serde_json::Error),
    FileNotFound { path: String },
    InvalidPath { path: String },
    DirectoryScan(String),
    Server(String),
    Config(String),
}
```
- **èŒè´£**ï¼šç»Ÿä¸€åº”ç”¨çº§é”™è¯¯å¤„ç†
- **ç‰¹æ€§**ï¼šå®ç° `From<LithoBookError> for StatusCode`ï¼Œè‡ªåŠ¨æ˜ å°„ä¸º HTTP çŠ¶æ€ç 

#### `async-stream` ç»„ä»¶
ç”¨äºå®ç° `/api/chat` çš„æµå¼å“åº”ï¼š
```rust
let stream = async_stream::stream! {
    yield Ok(Event::default().event("start").data(...));
    while let Some(chunk) = response_stream.recv().await {
        yield Ok(Event::default().event("content").data(...));
    }
    yield Ok(Event::default().event("finish").data(...));
};
Sse::new(stream)
```

### ç»„ä»¶èŒè´£åˆ’åˆ†
| ç»„ä»¶ | èŒè´£ | ä¾èµ– |
|------|------|-------|
| `Args` | å‘½ä»¤è¡Œå‚æ•°æ¥æ”¶ä¸éªŒè¯ | Clap |
| `DocumentTree` | æ–‡æ¡£ç»“æ„å»ºæ¨¡ä¸æœç´¢ | std::fs, pulldown-cmark |
| `AppState` | Web æœåŠ¡çŠ¶æ€å…±äº« | DocumentTree |
| `LithoBookError` | é”™è¯¯ç»Ÿä¸€æŠ½è±¡ | thiserror, axum::http::StatusCode |
| `OpenAIRequest` | AI API è¯·æ±‚å°è£… | serde |
| `StreamEvent` | SSE äº‹ä»¶æ ¼å¼å®šä¹‰ | serde |

### ç»„ä»¶äº¤äº’å…³ç³»
```mermaid
classDiagram
    direction LR

    class Args {
        +docs_dir: PathBuf
        +port: u16
        +host: String
        +open: bool
        +validate() Result~()
        +server_url() String
        +bind_address() String
    }

    class DocumentTree {
        +root: FileNode
        +file_map: HashMap~String,PathBuf~
        +stats: TreeStats
        +search_index: HashMap~String,Vec~String~~
        +new(docs_dir) Result~Self~
        +get_file_content(file_path) Result~String~
        +render_markdown(content) String
        +search_content(query) Vec~SearchResult~
    }

    class AppState {
        +doc_tree: DocumentTree
        +docs_path: String
    }

    class LithoBookError {
        +Io(std::io::Error)
        +Json(serde_json::Error)
        +FileNotFound(String)
        +InvalidPath(String)
        +DirectoryScan(String)
        +Server(String)
        +Config(String)
    }

    class ChatRequest {
        +message: String
        +context: Option~String~
        +history: Option~Vec~OpenAIMessage~~
    }

    class StreamEvent {
        +event_type: String
        +content: Option~String~
        +suggestions: Option~Vec~String~~
        +finished: bool
    }

    Args --> DocumentTree : åˆ›å»ºæ—¶ä¼ å…¥è·¯å¾„
    DocumentTree --> AppState : æ³¨å…¥çŠ¶æ€
    DocumentTree --> LithoBookError : é”™è¯¯ä¼ æ’­
    ChatRequest --> StreamEvent : ç”Ÿæˆå“åº”äº‹ä»¶
    StreamEvent --> Sse : æ„é€  SSE æµ
```

---

## 5. å…³é”®æµç¨‹ (Key Processes)

### æ ¸å¿ƒåŠŸèƒ½æµç¨‹

#### é¡¹ç›®å¯åŠ¨ä¸æœåŠ¡åˆå§‹åŒ–æµç¨‹
```mermaid
graph TD
    A[ç”¨æˆ·æ‰§è¡Œå‘½ä»¤è¡Œå¯åŠ¨] --> B[è§£æå‘½ä»¤è¡Œå‚æ•°]
    B --> C[åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ]
    C --> D[æ„å»ºæ–‡æ¡£æ ‘]
    D --> E[åˆ›å»º HTTP æœåŠ¡å™¨]
    E --> F[å¯åŠ¨ HTTP æœåŠ¡]
    F --> G[è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨]
```

**è¯¦ç»†æ­¥éª¤**ï¼š
1. ç”¨æˆ·æ‰§è¡Œ `litho-book --path ./docs --port 3000`
2. `cli.rs` è§£æå‚æ•°å¹¶éªŒè¯è·¯å¾„åˆæ³•æ€§
3. `main.rs` åˆå§‹åŒ– Tracing æ—¥å¿—ç³»ç»Ÿ
4. è°ƒç”¨ `filesystem::DocumentTree::new()` æ‰«æç›®å½•
5. æ„å»ºå®Œæˆååˆ›å»º `AppState` å¹¶ç»‘å®šåˆ° Axum è·¯ç”±å™¨
6. å¯åŠ¨ TCP ç›‘å¬å™¨ï¼Œå¼€å§‹æ¥å—è¿æ¥
7. è‹¥ `--open` å‚æ•°å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ç³»ç»Ÿå‘½ä»¤æ‰“å¼€æµè§ˆå™¨

#### æ–‡æ¡£å…¨æ–‡æœç´¢æµç¨‹
```mermaid
graph TD
    A[ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®è¯] --> B[æ¥æ”¶æœç´¢è¯·æ±‚]
    B --> C[æ‰§è¡Œå…¨æ–‡æ£€ç´¢]
    C --> D[æ’åºå¹¶é«˜äº®ç»“æœ]
    D --> E[è¿”å›æœç´¢ç»“æœ]
```

**æŠ€æœ¯è·¯å¾„**ï¼š
1. å‰ç«¯å‘é€ `GET /api/search?q=æ€§èƒ½ä¼˜åŒ–`
2. `search_handler` æå–æŸ¥è¯¢å‚æ•°
3. è°ƒç”¨ `doc_tree.search_content("æ€§èƒ½ä¼˜åŒ–")`
4. éå† `search_index`ï¼Œé€è¡Œæ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®è¯
5. è®¡ç®—ç›¸å…³æ€§è¯„åˆ†ï¼ˆæ ‡é¢˜åŠ æƒã€ç²¾ç¡®åŒ¹é…ç­‰ï¼‰
6. å¯¹ç»“æœæŒ‰åˆ†æ•°é™åºæ’åˆ—ï¼Œæˆªæ–­è‡³æœ€å¤š 50 æ¡
7. æ·»åŠ  `<mark>` é«˜äº®æ ‡ç­¾åè¿”å› JSON

#### AI åŠ©æ‰‹æµå¼å¯¹è¯æµç¨‹
```mermaid
graph TD
    A[ç”¨æˆ·æäº¤é—®é¢˜] --> B[æ¥æ”¶èŠå¤©è¯·æ±‚]
    B --> C[æ„å»º AI è¯·æ±‚å†…å®¹]
    C --> D[è°ƒç”¨ AI API]
    D --> E[æµå¼è¿”å›å“åº”]
```

**æ‰§è¡Œç»†èŠ‚**ï¼š
1. å‰ç«¯ POST `{message: "å¦‚ä½•ä½¿ç”¨ï¼Ÿ", context: "..."}`
2. `chat_stream_handler` å¯åŠ¨å¼‚æ­¥æµ
3. æ„é€ åŒ…å«ç³»ç»Ÿæç¤ºã€ä¸Šä¸‹æ–‡ã€å†å²ä¼šè¯çš„ OpenAI è¯·æ±‚
4. ä½¿ç”¨ `reqwest` å‘èµ·æµå¼ POST è¯·æ±‚åˆ°æ™ºè°±AI
5. åœ¨åå°ä»»åŠ¡ä¸­è§£æ SSE å­—èŠ‚æµï¼Œæå– `delta.content`
6. é€šè¿‡ `tokio::sync::mpsc::channel` å°†å†…å®¹æ¨é€åˆ°å‰ç«¯
7. æœ€ç»ˆç”Ÿæˆæ¨èè¿½é—®é—®é¢˜å¹¶å‘é€å®Œæˆäº‹ä»¶

### å¼‚å¸¸å¤„ç†æœºåˆ¶
ç³»ç»Ÿå»ºç«‹äº†å®Œå–„çš„é”™è¯¯å¤„ç†é“¾æ¡ï¼š

```mermaid
graph TB
    A[IOé”™è¯¯] --> B[æ–‡ä»¶ç³»ç»Ÿæ¨¡å—]
    B --> C[è½¬æ¢ä¸ºLithoBooké”™è¯¯Ioç±»å‹]
    C --> D[é”™è¯¯å¤„ç†æ¨¡å—]
    D --> E[å®ç°Fromåˆ°StatusCodeçš„è½¬æ¢]
    E --> F[è¿”å›Axum HTTPå“åº”]

    G[JSONè§£æé”™è¯¯] --> H[æœåŠ¡å™¨æ¨¡å—]
    H --> I[è½¬æ¢ä¸ºLithoBooké”™è¯¯Jsonç±»å‹]
    I --> D

    J[æ–‡ä»¶æœªæ‰¾åˆ°] --> K[è¯»å–æ–‡ä»¶å†…å®¹å‡½æ•°]
    K --> L[è½¬æ¢ä¸ºLithoBooké”™è¯¯FileNotFoundç±»å‹]
    L --> D
```

**é”™è¯¯æ˜ å°„è§„åˆ™**ï¼š
| åº”ç”¨é”™è¯¯ | HTTP çŠ¶æ€ç  |
|---------|------------|
| `FileNotFound` | 404 Not Found |
| `InvalidPath` | 400 Bad Request |
| `Io`, `Json`, `DirectoryScan` | 500 Internal Server Error |
| `Config` | 400 Bad Request |

---

## 6. æŠ€æœ¯å®ç° (Technical Implementation)

### æ ¸å¿ƒæ¨¡å—å®ç°

#### æ–‡æ¡£æ ‘æ„å»ºç®—æ³•
```rust
fn build_tree(
    current_path: &Path,
    base_path: &Path,
    file_map: &mut HashMap<String, PathBuf>,
    search_index: &mut HashMap<String, Vec<String>>,
    stats: &mut TreeStats,
) -> anyhow::Result<FileNode>
```
- **é€’å½’ç­–ç•¥**ï¼šæ·±åº¦ä¼˜å…ˆéå†ç›®å½•ç»“æ„
- **æ’åºè§„åˆ™**ï¼šç›®å½•ä¼˜å…ˆäºæ–‡ä»¶ï¼ŒåŒç±»å‹æŒ‰åç§°å‡åºï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
- **è¿‡æ»¤æ¡ä»¶**ï¼š
  - è·³è¿‡ä»¥ `.` å¼€å¤´çš„éšè—æ–‡ä»¶
  - ä»…ç´¢å¼• `.md` åç¼€çš„æ–‡ä»¶
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¢„åˆ†é…å‘é‡å®¹é‡ï¼Œå‡å°‘å†…å­˜é‡æ–°åˆ†é…

#### å…¨æ–‡æœç´¢ç®—æ³•
```rust
pub fn search_content(&self, query: &str) -> Vec<SearchResult>
```
**è¯„åˆ†æ¨¡å‹**ï¼š
```text
relevance_score = Î£(line_score)
where:
  line_score = base_score Ã— modifiers

modifiers:
  - æ ‡é¢˜è¡Œ (ä»¥ # å¼€å¤´): Ã—3
  - ç²¾ç¡®å•è¯åŒ¹é…: Ã—2
  - è¡Œé¦–åŒ¹é…: Ã—1.5
  - æ–‡ä»¶ååŒ¹é…: +2 åˆ†
```

**é«˜äº®å®ç°**ï¼š
```rust
fn highlight_matches(&self, content: &str, query: &str) -> String {
    // ä¸åŒºåˆ†å¤§å°å†™çš„å­ä¸²æ›¿æ¢
    let start = content_lower.find(&query_lower)?;
    format!(\"{}<mark>{}</mark>{}\", before, matched, after)
}
```

#### æµå¼ AI å¯¹è¯å®ç°
é‡‡ç”¨ `async-stream` + `tokio::sync::mpsc` æ¨¡å¼ï¼š
```rust
let (tx, rx) = tokio::sync::mpsc::channel(100);
tokio::spawn(async move {
    let mut stream = response.bytes_stream();
    while let Some(chunk) = stream.next().await {
        if let Ok(data) = parse_sse_chunk(&chunk) {
            tx.send(Ok(content)).await.ok();
        }
    }
});
Sse::new(async_stream::stream! {
    while let Some(result) = rx.recv().await {
        yield Ok(Event::default().data(result.unwrap()));
    }
})
```

### æ•°æ®ç»“æ„è®¾è®¡
#### `FileNode` â€”â€” æ–‡ä»¶æ ‘èŠ‚ç‚¹
```rust
pub struct FileNode {
    pub name: String,
    pub path: String,
    pub is_file: bool,
    pub children: Vec<FileNode>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub size: Option<u64>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub modified: Option<String>,
}
```
- **åºåˆ—åŒ–ä¼˜åŒ–**ï¼šæ–‡ä»¶å¤¹ä¸åºåˆ—åŒ– `size` å’Œ `modified`
- **è·¯å¾„æ ‡å‡†åŒ–**ï¼šWindows ä¸‹ `\` æ›¿æ¢ä¸º `/`

#### `SearchResult` â€”â€” æœç´¢ç»“æœ
```rust
pub struct SearchResult {
    pub file_path: String,
    pub file_name: String,
    pub title: Option<String>, // ä»ç¬¬ä¸€ä¸ª # æ ‡é¢˜æå–
    pub matches: Vec<SearchMatch>,
    pub relevance_score: f32,
}
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
| ä¼˜åŒ–ç‚¹ | å®ç°æ–¹å¼ | æ•ˆæœ |
|-------|---------|------|
| **å†…å­˜ç´¢å¼•** | å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰ `.md` æ–‡ä»¶å†…å®¹ | é¿å…é‡å¤ç£ç›˜è¯»å– |
| **æœç´¢åŠ é€Ÿ** | é¢„åˆ†å‰²æ¯è¡Œæ–‡æœ¬åˆ° `search_index` | å‡å°‘å­—ç¬¦ä¸²æ‰«æå¼€é”€ |
| **å¹¶å‘å¤„ç†** | Tokio å¼‚æ­¥è¿è¡Œæ—¶ | é«˜å¹¶å‘ä¸‹ä¿æŒä½å»¶è¿Ÿ |
| **æµå¼ä¼ è¾“** | SSE åˆ†å—è¿”å› AI å“åº” | ç”¨æˆ·æ— éœ€ç­‰å¾…å®Œæ•´å›å¤ |
| **æ—¥å¿—æ§åˆ¶** | `--verbose` æ§åˆ¶æ—¥å¿—çº§åˆ« | ç”Ÿäº§ç¯å¢ƒå‡å°‘ I/O å½±å“ |

---

## 7. éƒ¨ç½²æ¶æ„ (Deployment Architecture)

### è¿è¡Œç¯å¢ƒè¦æ±‚
| é¡¹ç›® | è¦æ±‚ |
|------|------|
| **æ“ä½œç³»ç»Ÿ** | Windows, macOS, Linux |
| **Rust ç‰ˆæœ¬** | 2024 edition |
| **æœ€ä½æƒé™** | è¯»å–æ–‡æ¡£ç›®å½•æƒé™ï¼›è‹¥ç»‘å®š <1024 ç«¯å£éœ€ç®¡ç†å‘˜æƒé™ |
| **ç½‘ç»œ** | æœ¬åœ°å›ç¯æ¥å£ï¼ˆé»˜è®¤ `127.0.0.1`ï¼‰ |
| **ä¾èµ–** | æ— å¤–éƒ¨ä¾èµ–ï¼ˆé™æ€ç¼–è¯‘ï¼‰ |

### éƒ¨ç½²æ‹“æ‰‘ç»“æ„
```mermaid
graph TD
    Client[å®¢æˆ·ç«¯æµè§ˆå™¨] -->|HTTP| Server[(Litho Book æœåŠ¡)]
    Server -->|è¯»å–| Docs[(æœ¬åœ°æ–‡æ¡£ç›®å½•)]
    Server -->|HTTPS| ZhipuAI[ZhipuAI API]

    style Server fill:#4CAF50,stroke:#388E3C,color:white
    style Docs fill:#FFC107,stroke:#FFA000
    style ZhipuAI fill:#3F51B5,stroke:#303F9F,color:white
```

**å…¸å‹éƒ¨ç½²æ–¹å¼**ï¼š
```bash
# æœ¬åœ°å¼€å‘æ¨¡å¼
litho-book --path ./docs --port 3000 --open

# æœåŠ¡å™¨æ¨¡å¼ï¼ˆå…è®¸è¿œç¨‹è®¿é—®ï¼‰
litho-book --path /var/docs --host 0.0.0.0 --port 8080
```

### æ‰©å±•æ€§è®¾è®¡
#### å½“å‰æ‰©å±•ç‚¹
- âœ… **æ¨¡å—æ‹†åˆ†**ï¼šå¯é€šè¿‡ `mod` å…³é”®å­—å°†åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹ crate
- âœ… **é…ç½®æ‰©å±•**ï¼šç°æœ‰ CLI å‚æ•°ä½“ç³»æ˜“äºæ·»åŠ æ–°é€‰é¡¹
- âœ… **API æ‰©å±•**ï¼šAxum è·¯ç”±å™¨æ”¯æŒåŠ¨æ€æ³¨å†Œæ–°è·¯ç”±
- âœ… **AI é€‚é…**ï¼šAI è°ƒç”¨å°è£…è‰¯å¥½ï¼Œå¯æ›¿æ¢ä¸ºå…¶ä»– LLM æœåŠ¡

#### æ”¹è¿›å»ºè®®
1. **é…ç½®æ–‡ä»¶æ”¯æŒ**
   ```toml
   # litho-book.toml
   docs_dir = "./docs"
   port = 3000
   host = "127.0.0.1"
   open_browser = true
   ```
2. **ç¯å¢ƒå˜é‡æ³¨å…¥**
   ```bash
   export ZHIPUAI_API_KEY=your_key_here
   ```
3. **ç¼“å­˜æœºåˆ¶**
   - LRU Cache ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ¸²æŸ“ç»“æœ
   - Redis ç¼“å­˜ AI å¯¹è¯å†å²
4. **çƒ­é‡è½½**
   - ä½¿ç”¨ `notify` åº“ç›‘å¬æ–‡ä»¶å˜åŒ–
   - åŠ¨æ€æ›´æ–° `DocumentTree` è€Œæ— éœ€é‡å¯

### ç›‘æ§ä¸è¿ç»´
#### å†…å»ºç›‘æ§èƒ½åŠ›
- **å¥åº·æ£€æŸ¥**ï¼š`GET /health` è¿”å›æœåŠ¡çŠ¶æ€ä¸ç‰ˆæœ¬
- **ç»Ÿè®¡æ¥å£**ï¼š`GET /api/stats` æä¾›æ–‡æ¡£æ•°é‡ã€æ€»å¤§å°ç­‰æŒ‡æ ‡
- **ç»“æ„åŒ–æ—¥å¿—**ï¼šTracing è¾“å‡ºå¯è¢« ELK/Sentry ç­‰ç³»ç»Ÿé‡‡é›†

#### è¿ç»´å»ºè®®
| åœºæ™¯ | å»ºè®® |
|------|------|
| **ç”Ÿäº§éƒ¨ç½²** | ä½¿ç”¨ systemd/pm2 ç®¡ç†è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ |
| **æ—¥å¿—åˆ†æ** | é‡å®šå‘æ—¥å¿—åˆ°æ–‡ä»¶æˆ–é›†ä¸­å¼æ—¥å¿—ç³»ç»Ÿ |
| **å®‰å…¨æ€§** | é¿å…ç»‘å®š `0.0.0.0` è‡³å…¬ç½‘ï¼Œæˆ–æ·»åŠ èº«ä»½éªŒè¯ä¸­é—´ä»¶ |
| **å¤‡ä»½ç­–ç•¥** | å®šæœŸå¤‡ä»½åŸå§‹ Markdown æ–‡æ¡£ç›®å½• |

> ğŸ“Œ **æœ€ä½³å®è·µ**ï¼šå°† `litho-book` ä½œä¸ºå¼€å‘æ–‡æ¡£çš„æ ‡å‡†æŸ¥çœ‹å·¥å…·é›†æˆåˆ° CI/CD æµç¨‹ä¸­ï¼Œæ¯æ¬¡æ„å»ºåè‡ªåŠ¨ç”Ÿæˆå¹¶é¢„è§ˆæ–‡æ¡£ç«™ç‚¹ã€‚
